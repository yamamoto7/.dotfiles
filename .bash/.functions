function search_history {
  # local selected=$(HISTTIMEFORMAT= history | cut -c 8- | peco --query "$READLINE_LINE")
  # local selected=$(HISTTIMEFORMAT= history | cut -c 8- | fzf --query="$READLINE_LINE")
  local selected=$(HISTTIMEFORMAT= history | cut -c 8- | awk '!a[$0]++' | peco --query "$READLINE_LINE")

  if [ -n "$selected" ]; then
    READLINE_LINE="$selected"
    READLINE_POINT=${#selected}
    history -s "$selected"
  fi
}

function repo() {
  if [ $# -eq 0 ]; then
    tmp=`pwd`
  else
    tmp=$1
  fi
  (
    cd $tmp
    repo_url=$(git remote -v | head -n 1 | awk '{
      gsub("git@github.com:", "https://github.com/", $2)
      print substr($2, 1, length($2) - 4)
    }')
    current_branch=$(git rev-parse --abbrev-ref HEAD)
    full_url="${repo_url}/tree/${current_branch}"
    open "${full_url}"
  )
}

function remove_duplicates() {
  input_file=$1
  output_file=$2

  if [ -z "$input_file" ] || [ -z "$output_file" ]; then
    echo "Usage: remove_duplicates input_file output_file"
    return 1
  fi

  iconv -c -f UTF-8 -t UTF-8 "$input_file" > "$output_file"
  awk '!seen[$0]++' "$output_file" > "$output_file"
}

# -y ã§ç¢ºèªãªã—ã‚³ãƒŸãƒƒãƒˆ
function commit_with_message() {
  local auto="no"
  while getopts ":y" opt; do
    case "$opt" in
      y) auto="yes" ;;
    esac
  done
  shift $((OPTIND-1))

  if git diff --staged --quiet; then
    echo "ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ã•ã‚ŒãŸå¤‰æ›´ãŒã‚ã‚Šã¾ã›ã‚“"; return 1
  fi

  # ä¾å­˜ CLI ã®ç¢ºèªï¼ˆclaude CLI ã‚’æƒ³å®šï¼‰
  if ! command -v claude >/dev/null 2>&1; then
    echo "claude CLI ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã¾ãŸã¯ PATH è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
    return 1
  fi

  # ãƒªãƒã‚¸ãƒˆãƒªæƒ…å ±
  local repo branch toplevel
  repo="$(basename "$(git rev-parse --show-toplevel)")"
  branch="$(git rev-parse --abbrev-ref HEAD 2>/dev/null || echo unknown)"
  toplevel="$(git rev-parse --show-toplevel)"

  # å¤‰æ›´ã®è¦ç´„ã¨å·®åˆ†
  local names numstat diff scope_hint
  names="$(git diff --staged --name-status --no-color)"
  numstat="$(git diff --staged --numstat --no-color)"

  # scope ãƒ’ãƒ³ãƒˆï¼ˆæœ€åˆã®å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒˆãƒƒãƒ—ãƒ¬ãƒ™ãƒ«ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªï¼‰
  scope_hint="$(printf '%s\n' "$numstat" | awk 'NR==1{print $3}' | cut -d/ -f1)"
  [ -z "$scope_hint" ] && scope_hint="$repo"

  # ãƒ•ãƒ«å·®åˆ†ï¼ˆé•·ã„å ´åˆã¯ U=0 + ãƒˆãƒªãƒ ï¼‰
  diff="$(git diff --staged --no-color)"
  local MAX_DIFF_CHARS=80000
  if [ ${#diff} -gt $MAX_DIFF_CHARS ]; then
    # æ–‡è„ˆãªã—å·®åˆ†ã«åˆ‡æ›¿
    diff="$(git diff --staged --no-color -U0)"
    # ãã‚Œã§ã‚‚é•·ã‘ã‚Œã°é ­ã ã‘æ®‹ã™
    if [ ${#diff} -gt $MAX_DIFF_CHARS ]; then
      diff="${diff:0:$MAX_DIFF_CHARS}
... [TRUNCATED: original staged diff exceeded ${MAX_DIFF_CHARS} chars] ..."
    fi
  fi

  # çµµæ–‡å­—ã‚¿ã‚¤ãƒ—ã‚’ä½¿ã†ã‹ï¼ˆcommitlint ä½µç”¨ãªã‚‰ 0 æ¨å¥¨ï¼‰
  local USE_EMOJI_TYPES=${USE_EMOJI_TYPES:-1}

  # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆ
  local guidelines type_hint
  if [ "$USE_EMOJI_TYPES" = "1" ]; then
    type_hint="Allowed <type>: \`âœ¨ feat:\`, \`ğŸ› fix:\`, \`ğŸ“ docs:\`, \`ğŸ¨ style:\`, \`â™»ï¸ refactor:\`, \`âš¡ï¸ perf:\`, \`âœ… test:\`, \`ğŸ—ï¸ build:\`, \`ğŸ‘· ci:\`, \`ğŸ”§ chore:\`, \`âª revert:\`."
  else
    type_hint="Allowed <type>: \`feat\`, \`fix\`, \`docs\`, \`style\`, \`refactor\`, \`perf\`, \`test\`, \`build\`, \`ci\`, \`chore\`, \`revert\`."
  fi

  guidelines="$(printf '%s\n' \
"You are writing a Conventional Commits message in ENGLISH from the staged git diff.
Context:
- repo: $repo
- branch: $branch
- likely scope hint: $scope_hint

Requirements:
- Output a complete commit message: one-line header, then a blank line, then a multi-line body if useful.
- The header MUST be: <type>(<scope>)!: <subject>  (no space before the colon; include ! only when breaking).
- $type_hint
- Keep subject â‰¤ 72 chars, imperative, no trailing period.
- Body explains WHAT and WHY (not low-level HOW), wrap at ~72 chars/line.
- If breaking, add a \`BREAKING CHANGE:\` section in the body.
- If relevant, add references like \`Refs: #123\` on separate lines at the end.
- DO NOT return code fences or extra commentary â€” only the commit text.
- Do NOT add any footer/signature lines or any "Co-Authored-By" trailers.

Changed files (name-status):
$names

Numstat (added<TAB>deleted<TAB>file):
$numstat

---DIFF---
$diff
")"

  # ç”Ÿæˆå®Ÿè¡Œï¼ˆstdout ã®ã‚³ãƒ¼ãƒ‰ãƒ•ã‚§ãƒ³ã‚¹/æœ«å°¾ç©ºç™½/CR ã‚’é™¤å»ï¼‰
  local msg
  msg="$(
    claude -p "$guidelines" --output-format text --model sonnet 2>/dev/null \
    | sed -e '1{/^```/d;}' -e '${/^```/d;}' -e 's/[[:space:]]\+$//' -e 's/\r$//'
  )"
  local exit_code=$?

  if [ $exit_code -ne 0 ] || [ -z "$msg" ] || [ "$msg" = "null" ]; then
    echo "ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ (exit=$exit_code)"; return 1
  fi

  # ãƒ†ãƒ³ãƒãƒ©ãƒªãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ï¼ˆç·¨é›†å¯èƒ½ã«ã™ã‚‹ï¼‰
  local tmpfile
  tmpfile="$(mktemp -t ai-commit.XXXXXX)"
  printf '%s\n' "$msg" >"$tmpfile"

  # ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
  echo "----- commit preview -----"
  cat "$tmpfile"
  echo "--------------------------"

  # 72 æ–‡å­—è¶…éã®è»½ã„è­¦å‘Šï¼ˆãƒ˜ãƒƒãƒ€ã®ã¿ï¼‰
  local header
  header="$(head -n1 "$tmpfile")"
  if [ "${#header}" -gt 72 ]; then
    echo "âš ï¸  ãƒ˜ãƒƒãƒ€ãŒ 72 æ–‡å­—ã‚’è¶…ãˆã¦ã„ã¾ã™ (${#header} chars)"
  fi

  if [ "$auto" = "yes" ]; then
    git commit -F "$tmpfile"
    local res=$?
    rm -f "$tmpfile"
    return $res
  fi

  # ç·¨é›† or å³ã‚³ãƒŸãƒƒãƒˆ
  echo -n "ã“ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§ã‚³ãƒŸãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ [y=ã‚³ãƒŸãƒƒãƒˆ / e=ç·¨é›†ã—ã¦ã‹ã‚‰ / N=ä¸­æ­¢] "
  read -r ans
  case "$ans" in
    y|Y|yes|YES)
      git commit -F "$tmpfile"
      ;;
    e|E|edit|EDIT)
      "${GIT_EDITOR:-${EDITOR:-vi}}" "$tmpfile"
      echo -n "ç·¨é›†å¾Œã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§ã‚³ãƒŸãƒƒãƒˆã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ [y/N] "
      read -r ans2
      case "$ans2" in
        y|Y|yes|YES) git commit -F "$tmpfile" ;;
        *) echo "ä¸­æ­¢ã—ã¾ã—ãŸ" ;;
      esac
      ;;
    *) echo "ä¸­æ­¢ã—ã¾ã—ãŸ" ;;
  esac
  rm -f "$tmpfile"
}

bind -x '"\C-r": search_history'
