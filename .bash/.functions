#!/usr/bin/env bash

# ============================================
# History Search with fzf
# ============================================
function search_history {
  local selected
  selected=$(HISTTIMEFORMAT= history | cut -c 8- | awk '!a[$0]++' | \
    fzf --tac --no-sort --query "$READLINE_LINE" \
        --height=40% \
        --layout=reverse \
        --border \
        --preview-window=hidden \
        --bind 'ctrl-y:execute-silent(echo -n {} | pbcopy)+abort')
  if [ -n "$selected" ]; then
    READLINE_LINE="$selected"
    READLINE_POINT=${#selected}
    history -s "$selected"
  fi
}

# ============================================
# GCP Project Switcher
# ============================================
gset() {
  command -v gcloud >/dev/null 2>&1 || { echo "gcloud ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"; return 1; }
  command -v fzf    >/dev/null 2>&1 || { echo "fzf ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“";   return 1; }

  local choice id
  choice="$(
    gcloud projects list --format='value(projectId,name,projectNumber)' \
    | awk '{id=$1; $1=""; printf "%s  %s\n", id, substr($0,2)}' \
    | fzf --prompt 'GCP project > ' --height=40% --layout=reverse --border
  )" || return 1

  [ -z "$choice" ] && { echo "ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ"; return 1; }

  id="${choice%%[[:space:]]*}"

  echo "â†’ gcloud config set project $id"
  gcloud config set project "$id" --quiet || return 1

  gcloud auth application-default set-quota-project "$id" --quiet >/dev/null 2>&1 || true

  echo "ç¾åœ¨ã® project: $(gcloud config get-value project)"
}

# ============================================
# Open GitHub Repository
# ============================================
function repo() {
  if [ $# -eq 0 ]; then
    tmp=`pwd`
  else
    tmp=$1
  fi
  (
    cd $tmp
    repo_url=$(git remote -v | head -n 1 | awk '{
      gsub("git@github.com:", "https://github.com/", $2)
      print substr($2, 1, length($2) - 4)
    }')
    current_branch=$(git rev-parse --abbrev-ref HEAD)
    full_url="${repo_url}/tree/${current_branch}"
    open "${full_url}"
  )
}

# ============================================
# Remove Duplicates from File
# ============================================
function remove_duplicates() {
  input_file=$1
  output_file=$2

  if [ -z "$input_file" ] || [ -z "$output_file" ]; then
    echo "Usage: remove_duplicates input_file output_file"
    return 1
  fi

  iconv -c -f UTF-8 -t UTF-8 "$input_file" > "$output_file"
  awk '!seen[$0]++' "$output_file" > "$output_file"
}

# ============================================
# AI Commit Message Generator
# ============================================
function commit_with_message() {
  local auto="no"
  while getopts ":y" opt; do
    case "$opt" in
      y) auto="yes" ;;
    esac
  done
  shift $((OPTIND-1))

  if git diff --staged --quiet; then
    echo "ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ã•ã‚ŒãŸå¤‰æ›´ãŒã‚ã‚Šã¾ã›ã‚“"; return 1
  fi

  if ! command -v claude >/dev/null 2>&1; then
    echo "claude CLI ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã¾ãŸã¯ PATH è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
    return 1
  fi

  local repo branch toplevel
  repo="$(basename "$(git rev-parse --show-toplevel)")"
  branch="$(git rev-parse --abbrev-ref HEAD 2>/dev/null || echo unknown)"
  toplevel="$(git rev-parse --show-toplevel)"

  local names numstat diff scope_hint
  names="$(git diff --staged --name-status --no-color)"
  numstat="$(git diff --staged --numstat --no-color)"

  scope_hint="$(printf '%s\n' "$numstat" | awk 'NR==1{print $3}' | cut -d/ -f1)"
  [ -z "$scope_hint" ] && scope_hint="$repo"

  diff="$(git diff --staged --no-color)"
  local MAX_DIFF_CHARS=80000
  if [ ${#diff} -gt $MAX_DIFF_CHARS ]; then
    diff="$(git diff --staged --no-color -U0)"
    if [ ${#diff} -gt $MAX_DIFF_CHARS ]; then
      diff="${diff:0:$MAX_DIFF_CHARS}
... [TRUNCATED: original staged diff exceeded ${MAX_DIFF_CHARS} chars] ..."
    fi
  fi

  local USE_EMOJI_TYPES=${USE_EMOJI_TYPES:-1}

  local guidelines type_hint
  if [ "$USE_EMOJI_TYPES" = "1" ]; then
    type_hint="Allowed <type>: \`âœ¨ feat:\`, \`ğŸ› fix:\`, \`ğŸ“ docs:\`, \`ğŸ¨ style:\`, \`â™»ï¸ refactor:\`, \`âš¡ï¸ perf:\`, \`âœ… test:\`, \`ğŸ—ï¸ build:\`, \`ğŸ‘· ci:\`, \`ğŸ”§ chore:\`, \`âª revert:\`."
  else
    type_hint="Allowed <type>: \`feat\`, \`fix\`, \`docs\`, \`style\`, \`refactor\`, \`perf\`, \`test\`, \`build\`, \`ci\`, \`chore\`, \`revert\`."
  fi

  guidelines="$(printf '%s\n' \
"You are writing a Conventional Commits message in ENGLISH from the staged git diff.
Context:
- repo: $repo
- branch: $branch
- likely scope hint: $scope_hint

Requirements:
- Output a complete commit message: one-line header, then a blank line, then a multi-line body if useful.
- The header MUST be: <type>(<scope>)!: <subject>  (no space before the colon; include ! only when breaking).
- $type_hint
- Keep subject â‰¤ 72 chars, imperative, no trailing period.
- Body explains WHAT and WHY (not low-level HOW), wrap at ~72 chars/line.
- If breaking, add a \`BREAKING CHANGE:\` section in the body.
- If relevant, add references like \`Refs: #123\` on separate lines at the end.
- DO NOT return code fences or extra commentary â€” only the commit text.
- Do NOT add any footer/signature lines or any \"Co-Authored-By\" trailers.

Changed files (name-status):
$names

Numstat (added<TAB>deleted<TAB>file):
$numstat

---DIFF---
$diff
")"

  local msg
  msg="$(
    claude -p "$guidelines" --output-format text --model sonnet 2>/dev/null \
    | sed -e '1{/^```/d;}' -e '${/^```/d;}' -e 's/[[:space:]]\+$//' -e 's/\r$//'
  )"
  local exit_code=$?

  if [ $exit_code -ne 0 ] || [ -z "$msg" ] || [ "$msg" = "null" ]; then
    echo "ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ (exit=$exit_code)"; return 1
  fi

  local tmpfile
  tmpfile="$(mktemp -t ai-commit.XXXXXX)"
  printf '%s\n' "$msg" >"$tmpfile"

  echo "----- commit preview -----"
  cat "$tmpfile"
  echo "--------------------------"

  local header
  header="$(head -n1 "$tmpfile")"
  if [ "${#header}" -gt 72 ]; then
    echo "âš ï¸  ãƒ˜ãƒƒãƒ€ãŒ 72 æ–‡å­—ã‚’è¶…ãˆã¦ã„ã¾ã™ (${#header} chars)"
  fi

  if [ "$auto" = "yes" ]; then
    git commit -F "$tmpfile"
    local res=$?
    rm -f "$tmpfile"
    return $res
  fi

  echo -n "ã“ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§ã‚³ãƒŸãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ [y=ã‚³ãƒŸãƒƒãƒˆ / e=ç·¨é›†ã—ã¦ã‹ã‚‰ / N=ä¸­æ­¢] "
  read -r ans
  case "$ans" in
    y|Y|yes|YES)
      git commit -F "$tmpfile"
      ;;
    e|E|edit|EDIT)
      "${GIT_EDITOR:-${EDITOR:-vi}}" "$tmpfile"
      echo -n "ç·¨é›†å¾Œã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§ã‚³ãƒŸãƒƒãƒˆã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ [y/N] "
      read -r ans2
      case "$ans2" in
        y|Y|yes|YES) git commit -F "$tmpfile" ;;
        *) echo "ä¸­æ­¢ã—ã¾ã—ãŸ" ;;
      esac
      ;;
    *) echo "ä¸­æ­¢ã—ã¾ã—ãŸ" ;;
  esac
  rm -f "$tmpfile"
}

# ============================================
# Git Branch Switcher with fzf
# ============================================
function gco() {
  local branch
  branch=$(git branch -a --format='%(refname:short)' | \
    fzf --height=40% --layout=reverse --border --preview 'git log --oneline -10 {}')
  if [ -n "$branch" ]; then
    git checkout "$branch"
  fi
}

# ============================================
# fd + fzf file finder
# ============================================
function ff() {
  local file
  file=$(fd --type f --hidden --exclude .git | \
    fzf --height=60% --layout=reverse --border \
        --preview 'bat --color=always --style=numbers --line-range :200 {}')
  if [ -n "$file" ]; then
    ${EDITOR:-vim} "$file"
  fi
}

# ============================================
# fd + fzf directory changer
# ============================================
function cdf() {
  local dir
  dir=$(fd --type d --hidden --exclude .git | \
    fzf --height=40% --layout=reverse --border \
        --preview 'eza --tree --level=2 --icons {}')
  if [ -n "$dir" ]; then
    cd "$dir"
  fi
}

# ============================================
# Kill process with fzf
# ============================================
function fkill() {
  local pid
  pid=$(ps aux | sed 1d | fzf --height=40% --layout=reverse --border -m | awk '{print $2}')
  if [ -n "$pid" ]; then
    echo "$pid" | xargs kill -${1:-9}
  fi
}

# ============================================
# Docker container management with fzf
# ============================================
function dex() {
  local container
  container=$(docker ps --format '{{.Names}}\t{{.Image}}\t{{.Status}}' | \
    fzf --height=40% --layout=reverse --border | awk '{print $1}')
  if [ -n "$container" ]; then
    docker exec -it "$container" /bin/sh
  fi
}

function dlog() {
  local container
  container=$(docker ps -a --format '{{.Names}}\t{{.Image}}\t{{.Status}}' | \
    fzf --height=40% --layout=reverse --border | awk '{print $1}')
  if [ -n "$container" ]; then
    docker logs -f "$container"
  fi
}

# Bind Ctrl+R to fzf history search
bind -x '"\C-r": search_history'
